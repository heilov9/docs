
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Deploying in Kubernetes Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="Testing.html" />
    
    
    <link rel="prev" href="CSI-Driver.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="Home.html">
            
                <a href="Home.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="Setup.html">
            
                <a href="Setup.html">
            
                    
                    Using a CSI Driver
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="Deployment.html">
            
                <a href="Deployment.html">
            
                    
                    Deployment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="Drivers.html">
            
                <a href="Drivers.html">
            
                    
                    Drivers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="Usage.html">
            
                <a href="Usage.html">
            
                    
                    Usage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="Example.html">
            
                <a href="Example.html">
            
                    
                    Example
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="Development.html">
            
                <a href="Development.html">
            
                    
                    Development
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="CSI-Driver.html">
            
                <a href="CSI-Driver.html">
            
                    
                    Developing a CSI driver
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4.2" data-path="CSI-Kubernetes.html">
            
                <a href="CSI-Kubernetes.html">
            
                    
                    Deploying in Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="Testing.html">
            
                <a href="Testing.html">
            
                    
                    Testing
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.3.1" data-path="Testing-Clients.html">
            
                <a href="Testing-Clients.html">
            
                    
                    Clients
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3.2" data-path="Testing-Drivers.html">
            
                <a href="Testing-Drivers.html">
            
                    
                    Drivers
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="Troubleshooting.html">
            
                <a href="Troubleshooting.html">
            
                    
                    Troubleshooting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="References.html">
            
                <a href="References.html">
            
                    
                    References
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="Archive.html">
            
                <a href="Archive.html">
            
                    
                    Archive
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="Kubernetes-1.9.html">
            
                <a href="Kubernetes-1.9.html">
            
                    
                    Kubernetes 1.9
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Deploying in Kubernetes</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="deploying-in-kubernetes">Deploying in Kubernetes</h1>
<p>This page describes to CSI driver developers how to deploy their driver onto a Kubernetes cluster.</p>
<h2 id="overview">Overview</h2>
<p>There are three components plus the kubelet that enable CSI drivers to provide storage to Kubernetes. These components are sidecar containers which are responsible for communication with both Kubernetes and the CSI driver, making the appropriate CSI calls for their respectful Kubernetes events.</p>
<h2 id="sidecar-containers">Sidecar Containers</h2>
<p><a href="https://docs.google.com/a/greatdanedata.com/drawings/d/1JExJ_98dt0NAsJ7iI0_9loeTn2rbLeEcpOMEvKrF-9w/edit?usp=sharing" target="_blank"><img src="images/sidecar-container.png" alt="sidecar-container"></a></p>
<p>Sidecar containers manage Kubernetes events and make the appropriate calls to the CSI driver. These are the <em>external attacher</em>, <em>external provisioner</em>, and the <em>driver registrar</em>.</p>
<h3 id="external-attacher">External Attacher</h3>
<p><a href="https://github.com/kubernetes-csi/external-attacher" target="_blank">external-attacher</a> is a sidecar container that watches Kubernetes <em>VolumeAttachment</em> objects and triggers CSI <em>ControllerPublish</em> and <em>ControllerUnpublish</em> operations against a driver endpoint. As of this writing, the external attacher does not support leader election and therefore there can be only one running per CSI driver.  For more information please read <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/storage/container-storage-interface.md#attaching-and-detaching" target="_blank"><em>Attaching and Detaching</em></a>.</p>
<p>Note, even though this is called the <em>external attacher</em>, its function is to call the CSI API calls <em>ControllerPublish</em> and <em>ControllerUnpublish</em>. These calls most likely will occur in a node which is <em>not</em> the one that will mount the volume. For this reason, many CSI drivers do not support these calls, instead doing the attach/detach and mount/unmount both in the CSI <em>NodePublish</em> and <em>NodeUnpublish</em> calls done by the kubelet at the node which is supposed to mount.</p>
<h3 id="external-provisioner">External Provisioner</h3>
<p><a href="https://github.com/kubernetes-csi/external-provisioner" target="_blank">external-provisioner</a> is a Sidecar container that watches Kubernetes <em>PersistentVolumeClaim</em> objects and triggers CSI <em>CreateVolume</em> and <em>DeleteVolume</em> operations against a driver endpoint. For more information please read <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/storage/container-storage-interface.md#provisioning-and-deleting" target="_blank"><em>Provisioning and Deleting</em></a>.</p>
<h3 id="driver-registrar">Driver Registrar</h3>
<p><a href="https://github.com/kubernetes-csi/driver-registrar" target="_blank">driver-registrar</a> is a sidecar container that registers the CSI driver with kubelet, and adds the drivers custom NodeId to a label on the Kubernetes Node API Object. It does this by communicating with the <em>Identity</em> service on the CSI driver and also calling the CSI <em>GetNodeId</em> operation. The driver registrar must have the Kubernetes name for the node set through the environment variable <code>KUBE_NODE_NAME</code> as follows:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">        - name:</span> csi-driver-registrar
<span class="hljs-attr">          imagePullPolicy:</span> Always
<span class="hljs-attr">          image:</span> quay.io/k8scsi/driver-registrar:v0<span class="hljs-number">.2</span><span class="hljs-number">.0</span>
<span class="hljs-attr">          args:</span>
<span class="hljs-bullet">            -</span> <span class="hljs-string">&quot;--v=5&quot;</span>
<span class="hljs-bullet">            -</span> <span class="hljs-string">&quot;--csi-address=$(ADDRESS)&quot;</span>
<span class="hljs-attr">          env:</span>
<span class="hljs-attr">            - name:</span> ADDRESS
<span class="hljs-attr">              value:</span> /csi/csi.sock
<span class="hljs-attr">            - name:</span> KUBE_NODE_NAME
<span class="hljs-attr">              valueFrom:</span>
<span class="hljs-attr">                fieldRef:</span>
<span class="hljs-attr">                  fieldPath:</span> spec.nodeName
<span class="hljs-attr">          volumeMounts:</span>
<span class="hljs-attr">            - name:</span> socket-dir
<span class="hljs-attr">              mountPath:</span> /csi
</code></pre>
<h3 id="kubelet">Kubelet</h3>
<p><a href="https://docs.google.com/a/greatdanedata.com/drawings/d/1NXaVNDh3mSDhog7Q3Y9eELyEF24F8Z-Kk0ujR3pyOes/edit?usp=sharing" target="_blank"><img src="images/kubelet.png" alt="kubelet"></a></p>
<p>The Kubernetes kubelet runs on every node and is responsible for making the CSI calls <em>NodePublish</em> and <em>NodeUnpublish</em>. These calls mount and unmount the storage volume from the storage system, making it available to the Pod to consume. As shown in the <em>external-attacher</em>, most CSI drivers choose to implement both their attach/detach and mount/unmount calls in the <em>NodePublish</em> and <em>NodeUnpublish</em> calls. They do this because the kubelet makes the request on the node which is to consume the volume.</p>
<h3 id="mount-point">Mount point</h3>
<p>The mount point used by the CSI driver must be set to <em>Bidirectional</em>. See the example below:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">          volumeMounts:</span>
<span class="hljs-attr">            - name:</span> socket-dir
<span class="hljs-attr">              mountPath:</span> /csi
<span class="hljs-attr">            - name:</span> mountpoint-dir
<span class="hljs-attr">              mountPath:</span> /var/lib/kubelet/pods
<span class="hljs-attr">              mountPropagation:</span> <span class="hljs-string">&quot;Bidirectional&quot;</span>
<span class="hljs-attr">      volumes:</span>
<span class="hljs-attr">        - name:</span> socket-dir
<span class="hljs-attr">          hostPath:</span>
<span class="hljs-attr">            path:</span> /var/lib/kubelet/plugins/csi-hostpath
<span class="hljs-attr">            type:</span> DirectoryOrCreate
<span class="hljs-attr">        - name:</span> mountpoint-dir
<span class="hljs-attr">          hostPath:</span>
<span class="hljs-attr">            path:</span> /var/lib/kubelet/pods
<span class="hljs-attr">            type:</span> Directory
</code></pre>
<h3 id="rbac-rules">RBAC Rules</h3>
<p>Side car containers need the appropriate permissions to be able to access and manipulate Kubernetes objects. Here are the RBAC rules needed:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">kind:</span> ClusterRole
<span class="hljs-attr">apiVersion:</span> rbac.authorization.k8s.io/v1
<span class="hljs-attr">metadata:</span>
<span class="hljs-attr">  name:</span> csi-hostpath-role
<span class="hljs-attr">rules:</span>
<span class="hljs-attr">  - apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]
<span class="hljs-attr">    resources:</span> [<span class="hljs-string">&quot;persistentvolumes&quot;</span>]
<span class="hljs-attr">    verbs:</span> [<span class="hljs-string">&quot;create&quot;</span>, <span class="hljs-string">&quot;delete&quot;</span>, <span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>]
<span class="hljs-attr">  - apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]
<span class="hljs-attr">    resources:</span> [<span class="hljs-string">&quot;persistentvolumeclaims&quot;</span>]
<span class="hljs-attr">    verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>]
<span class="hljs-attr">  - apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]
<span class="hljs-attr">    resources:</span> [<span class="hljs-string">&quot;nodes&quot;</span>]
<span class="hljs-attr">    verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>]
<span class="hljs-attr">  - apiGroups:</span> [<span class="hljs-string">&quot;storage.k8s.io&quot;</span>]
<span class="hljs-attr">    resources:</span> [<span class="hljs-string">&quot;storageclasses&quot;</span>]
<span class="hljs-attr">    verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>]
<span class="hljs-attr">  - apiGroups:</span> [<span class="hljs-string">&quot;storage.k8s.io&quot;</span>]
<span class="hljs-attr">    resources:</span> [<span class="hljs-string">&quot;volumeattachments&quot;</span>]
<span class="hljs-attr">    verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>]
</code></pre>
<h2 id="deploying">Deploying</h2>
<p>Deploying a CSI driver onto Kubernetes is highlighted in detail in <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/storage/container-storage-interface.md#recommended-mechanism-for-deploying-csi-drivers-on-kubernetes" target="_blank"><em>Recommended Mechanism for Deploying CSI Drivers on Kubernetes</em></a>. </p>
<h3 id="examples">Examples</h3>
<ul>
<li>Simple deployment example using a single pod for all components: see the <a href="Example.html">hostpath example</a>.</li>
<li>Full deployment example using a <em>DaemonSet</em> for the node plugin and <em>StatefulSet</em> for the controller plugin: check the <a href="https://github.com/kubernetes-csi/drivers/tree/master/pkg/nfs/deploy/kubernetes" target="_blank">NFS driver deployment files</a>. </li>
</ul>
<h2 id="more-information">More information</h2>
<p>For more information, please read <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/storage/container-storage-interface.md" target="_blank"><em>CSI Volume Plugins in Kubernetes Design Doc</em></a>.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="CSI-Driver.html" class="navigation navigation-prev " aria-label="Previous page: Developing a CSI driver">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="Testing.html" class="navigation navigation-next " aria-label="Next page: Testing">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Deploying in Kubernetes","level":"1.4.2","depth":2,"next":{"title":"Testing","level":"1.4.3","depth":2,"path":"Testing.md","ref":"Testing.md","articles":[{"title":"Clients","level":"1.4.3.1","depth":3,"path":"Testing-Clients.md","ref":"Testing-Clients.md","articles":[]},{"title":"Drivers","level":"1.4.3.2","depth":3,"path":"Testing-Drivers.md","ref":"Testing-Drivers.md","articles":[]}]},"previous":{"title":"Developing a CSI driver","level":"1.4.1","depth":2,"path":"CSI-Driver.md","ref":"CSI-Driver.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"CSI-Kubernetes.md","mtime":"2018-03-25T19:09:52.481Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-03-25T19:15:51.790Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

